---
title: "Taller 3 - Experimento Aleatorio"
author: "Maria Camila Caraballo, Laura Sarif Rivera"
date: "2025-09-10"
output: pdf_document
output_dir: "outputs"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/mc-c2/OneDrive - Universidad de los andes/Universidad/MECA/Big Data y Machine Learning/Repositorios/BD_ML_taller_1/Taller-3-ExperimentoAleatorio")
```

## Experimentos Aleatorios

Este trabajo tiene como objetivo replicar parte de los resultados de Banerjee, Duflo, Glennerster y Kinnan (2015) sobre el impacto del microcrédito en Hyderabad, India. A través de esta replicación buscamos poner en práctica lo aprendido en clase y comprender cómo la evidencia empírica respalda (o cuestiona) las conclusiones sobre el papel de las microfinanzas en la reducción de la pobreza.

### 1. Análisis introductorio

Al introducir el artículo, los autores analizaron las limitaciones y lineamientos de la investigación de microcrédito publicada.

**¿Cuáles son los problemas en la identificación del impacto del microcrédito si uno simplemente compara los que tienen microcrédito y los que no tienen microcrédito? ¿Qué método utilizan los autores para identificar tal impacto? ¿Cómo resuelve ese método los problemas antes mencionados?**

Los principales problemas de identificación en este caso radican en que, si se comparan de manera ingenua los hogares que recibieron microcrédito con aquellos que no lo hicieron, surge un sesgo de selección. Esto ocurre porque pueden existir múltiples dimensiones observables y no observables que influyen tanto en la probabilidad de recibir un préstamo como en los resultados que se quieren evaluar. Por ejemplo, los hogares que buscan y obtienen microcrédito suelen ser más ambiciosos y tener mayores aspiraciones de emprender, expandir negocios o invertir en educación, lo que los hace sistemáticamente distintos de aquellos que no buscan crédito. Además, los prestatarios pueden contar con más activos, mejores redes sociales o un patrimonio inicial que los hace más aptos para acceder y aprovechar un préstamo. A nivel contextual también existe un sesgo de ubicación del programa, ya que las instituciones tienden a abrir sucursales en barrios donde esperan una demanda mínima y donde existen condiciones estructurales más favorables, dejando fuera barrios con características distintas.

Para superar estos problemas, los autores implementaron un experimento aleatorizado a nivel de barrio en Hyderabad, India. Partieron de 104 barrios identificados por Spandana como posibles lugares de expansión y los emparejaron según sus características socioeconómicas. Dentro de cada par, uno fue asignado aleatoriamente al tratamiento, es decir recibir una sucursal, y el otro al control. Como resultado, 52 barrios obtuvieron acceso al microcrédito y 52 quedaron como grupo de comparación.

La asignación aleatoria asegura que, en promedio, los barrios tratados y los de control sean equivalentes en sus condiciones previas tanto observables como no observables, de modo que la única diferencia sistemática entre ambos grupos es la intervención. Así, cualquier diferencia en los resultados posteriores puede atribuirse causalmente al acceso al microcrédito. Además, este diseño resuelve el problema de program placement al desligar la decisión de abrir sucursales de las condiciones del barrio, ya que no es la institución la que decide estratégicamente dónde expandirse, sino el azar. Con ello se elimina la posibilidad de que los mejores barrios sean los que reciban primero el programa, lo cual garantiza que la comparación refleje el verdadero impacto del microcrédito y no diferencias preexistentes.

### 2. Estimaciones originales

Los autores reportan los resultados de estimar la siguiente ecuación:

$$
y_{ia} = \alpha + \beta Treat_{ia} + X'_a\gamma + \epsilon_i
$$

Donde $y_{ia}$ es un resultado para el hogar $i$ en el área $a$, $Treat_{ia}$ es una dicótoma que toma el valor de 1 si el hogar está ubicado en un área tratada, mientras que $\beta$ es el efecto de $ITT$. $X_a$ es el vector con dimensión $K \cdot 1$ de variables de control

**¿Cuál es la unidad de análisis en el estudio?**

Si bien los hogares son la unidad de análisis empleada para medir los resultados, la aleatorización del tratamiento se llevó a cabo a nivel de barrio, de modo que la apertura de la sucursal se asignó colectivamente y no de manera individual.

**Replique la tabla 2 panel A, columnas 1 y 3 para mostrar el efecto de microfinanzas (ser tratado por el programa) en la obtención de más préstamos (acceso a créditos). Explique la intuición detrás de los resultados. Presente sus resultados con 4 cifras significativas.**

```{r}
# Cargar liberias y paquetes

#install.packages("haven") cual
#install.packages("plm")
#install.packages("skimr")
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("modelsummary")
#install.packages("knitr")
#install.packages("tinytex")
#tinytex::install_tinytex()
#install.packages("survey")
library(knitr)
library(haven)
library(plm)
library(scales)
library(skimr)
library(dplyr)
library(ggplot2)
library(AER)        
library(fixest)
library(lmtest)
library(sandwich)
library(tidyverse)
library(stargazer)
library(dplyr) 
library(survey)

# Leer archivo .dta
data <- read_dta("data_endline_1and2.dta")

# Ver base
str(data)

# Revisar NA de la base
colSums(is.na(data))

# Eliminar NA
data_inicial <- data %>% filter(!is.na(spandana_1))

# Filtrar solo hogares de Endline 1
data_inicial <- subset(data_inicial, sample1 == 1)

# Definir diseño muestral con pesos y clustering por área
design1 <- svydesign(
  id = ~areaid,   
  weights = ~w1,  
  data = data_inicial
)

# Regresiones
spandana <- svyglm(
  spandana_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
  design = design1,
  family = gaussian()
)

mfi <- svyglm(
  anymfi_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
  design = design1,
  family = gaussian()
)

# 6. Mostrar tabla de resultados
stargazer(spandana, mfi, type = "text",
          keep = "treatment",
          covariate.labels = c("Tratamiento"),
          dep.var.labels = c("Spandana",
                             "Cualquier MFI"),
          digits = 4,
          title = "Tabla 2- Crédito")
```

Los resultados muestran que, en el caso de *Spandana*, vivir en un barrio tratado incrementó en aproximadamente 12,7 puntos porcentuales la probabilidad de que un hogar tuviera un préstamo activo con esta institución, efecto que resulta estadísticamente significativo y refleja el impacto positivo y directo de la apertura de la sucursal sobre el uso de sus créditos.

En cuanto a la variable *Any MFI,* también se observa un efecto positivo y significativo: la probabilidad de contar con un préstamo de cualquier institución de microfinanzas aumentó en 8,3 puntos porcentuales en los barrios tratados. Este resultado confirma que la entrada de una nueva institución amplía la oferta y mejora el acceso, aunque el incremento es menor al observado para Spandana, lo cual sugiere que parte del aumento corresponde a un desplazamiento de clientes desde otras MFIs.

**Replique la tabla 3 panel A, columnas 3 y 4. Explique la intuición detrás de los resultados.**

```{r}
# Revisar NA de la base
colSums(is.na(data))

# Eliminar NA
data_gasto <- data %>% filter(!is.na(bizexpense_1))
data_ganancia <- data %>% filter(!is.na(bizprofit_1))

# Definir diseño muestral con pesos y clustering por área en cada base
design2 <- svydesign(
  id = ~ areaid,   # cluster nivel área
  weights = ~ w1,  # pesos 
  data = data_gasto
)

design3 <- svydesign(
  id = ~ areaid,   # cluster nivel área
  weights = ~ w1,  # pesos 
  data = data_ganancia
)

# Columna 3
gasto <- svyglm(
  bizexpense_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
  design = design2,
  data = data_gasto
)

# Columna 4
ganancia <- svyglm(
  bizprofit_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
  design = design3,
  data = data_ganancia
)

# Tabla 
stargazer(gasto, ganancia, type = "text",
          keep = "treatment",
          covariate.labels = c("Treatment"),
          dep.var.labels = c("Gasto",
                             "Ganancias"),
          digits = 0,
          title = "TABLA 3 -(Panel A)")
```

La Tabla 3 muestra que, aunque los efectos del tratamiento sobre los gastos y las ganancias de los negocios son positivos, ninguno de ellos resulta estadísticamente significativo. Esto significa que, en promedio, el acceso al microcrédito no generó un aumento claro ni en la inversión en insumos ni en las utilidades de los hogares. Como los datos incluyen ceros para aquellos que no tienen un negocio, los resultados sugieren que la disponibilidad de crédito no necesariamente se traduce en un incremento de ingresos para los hogares pobres a través de la expansión de sus actividades empresariales.

En este sentido, los hallazgos cuestionan la idea de que el financiamiento mediante microcrédito sea un determinante suficiente para mejorar las condiciones económicas de los hogares o para incentivar de manera sistemática la creación de nuevos emprendimientos.

**Usando “any MFI” como definición del tratamiento y “Treated Area” como asignación aleatoria inicial, calcule la tasa de cumplimiento (*compliance rate*) ¿Parece ser alta o baja?**

Con base en los resultados, la tasa de participación efectiva en microcrédito es del 25 % en los hogares de áreas tratadas y del 18 % en los de control. La diferencia entre ambos grupos, equivalente a 7 puntos porcentuales, constituye la tasa de cumplimiento. Este valor es relativamente bajo, lo que indica que la asignación a un área tratada solo aumentó de manera limitada la probabilidad de acceder a un préstamo. En consecuencia, el instrumento derivado de la asignación aleatoria resulta válido pero débil, ya que no genera un cambio sustancial en la participación en instituciones de microcrédito.

```{r}

# Eliminar NA
data_clean <- data %>% filter(!is.na(anymfi_1), !is.na(treatment), !is.na(w1))

# tasas de cumplimiento por grupo
comp_rates <- data_clean %>%
  group_by(treatment) %>%
  summarise(tasa_cumplimiento = weighted.mean(anymfi_1, w = w1, na.rm = TRUE))

# calcular la diferencia (first stage)
first_stage <- comp_rates$tasa_cumplimiento[comp_rates$treatment == 1] -
               comp_rates$tasa_cumplimiento[comp_rates$treatment == 0]

p <- first_stage 
```

### 3. Cálculo de impacto

Ahora quieres estimar el impacto de recibir efectivamente un microcrédito sobre 2 variables: i) el consumo total (total_exp_mo_pc_1) y ii) los beneficios del negocio (*bizprofit_2*)

Para ello, se toma como variable de tratamiento efectivo a la dicótoma *anymfi_1* que toma el valor de uno si el hogar recibió algún préstamo de cualquier IMF para la línea final 1 y cero en caso contrario. Podemos tomar como instrumento el hecho de que la ubicación de los bancos fue aleatoria. Para esto, use como instrumento en sus estimaciones la asignación aleatoria.

Finalmente, no incluya ningún control en sus estimaciones y responda las siguientes preguntas teniendo en cuenta estas nociones y variables:

**¿Cuáles son los supuestos necesarios para que los estimadores de VI sean válidos (en el contexto del artículo)?**

En el artículo, la estrategia empírica busca estimar el efecto causal de recibir un préstamo de microcrédito de instituciones financieras sobre variables como el consumo y las utilidades del negocio. Dado que el acceso al crédito no fue asignado de manera estrictamente aleatoria, sino que surgió como un spillover derivado de la apertura de sucursales, los autores emplean como instrumento la ubicación aleatoria de los bancos. Para que esta estrategia de variables instrumentales sea válida, deben cumplirse ciertos supuestos fundamentales.

En primer lugar, el instrumento debe ser relevante, lo que significa que la ubicación aleatoria de las sucursales debe estar correlacionada de manera significativa con la probabilidad de que un hogar reciba un microcrédito. En términos prácticos, vivir en un barrio tratado debería aumentar de forma sustancial la probabilidad de acceder a un préstamo.

En segundo lugar, el instrumento debe ser exógeno, es decir, independiente de los factores no observados que influyen directamente en las variables de interés, como el consumo o las condiciones del hogar. En este caso, la exogeneidad se justifica porque la asignación de las sucursales fue producto de un procedimiento aleatorio; por lo tanto, residir en un área tratada no debería estar relacionado con características previas de los hogares. De igual manera, debe cumplirse la condición de exclusión, que establece que la apertura de la sucursal solo puede afectar el consumo y las condiciones del hogar a través de su impacto sobre la probabilidad de recibir un microcrédito, y no mediante otros mecanismos alternativos como cambios en expectativas, precios locales o salarios.

Finalmente, se requiere la condición demonotonicidad, que implica que no debe existir un grupo de hogares para quienes la apertura de la sucursal reduzca la probabilidad de acceder a microcrédito. En otras palabras, la presencia de una sucursal no debería hacer que un hogar que habría solicitado un préstamo en ausencia del tratamiento deje de hacerlo.

**Para cada una de las dos variables, estime el efecto *Local Average Treament Effect* de obtener un préstamo, a través del método de Variable Instrumental. Estime también el ITT. Para cada tipo de efecto (LATE e ITT) presente una tabla con sus estimaciones y sus respectivos errores estándar. Interprete sus resultados, ¿Cuál es la diferencia en la interpretación de los dos tipos de efecto?**

```{r}

# Eliminar NA
data_exp <- data %>% filter(!is.na(total_exp_mo_pc_1))
data_prof <- data %>% filter(!is.na(bizprofit_1))

# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1_consumo <- lm(total_exp_mo_pc_1 ~ treatment, data = data_exp, weights = w1)
itt2_profit  <- lm(bizprofit_1 ~ treatment, data = data_prof, weights = w1)

# Guardar coeficientes ITT
itt_consumo_hat <- coef(itt1_consumo)["treatment"]
itt_profit_hat  <- coef(itt2_profit)["treatment"]

# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1_consumo <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w1, data = data_exp)
late2_profit <- ivreg(bizprofit_1 ~ anymfi_1 | treatment, weights = w1, data = data_prof)

# Guardar coeficientes LATE
late_consumo_iv <- coef(late1_consumo)["anymfi_1"]
late_profit_iv  <- coef(late2_profit)["anymfi_1"]

# Agrupar errores por barrio ITT
coeftest(itt1_consumo, vcov = vcovCL(itt1_consumo, cluster = ~ areaid))
coeftest(itt2_profit, vcov = vcovCL(itt2_profit, cluster = ~ areaid))

# Agrupar errores por barrio LATE
coeftest(late1_consumo, vcov = vcovCL(late1_consumo, cluster = ~ areaid))
coeftest(late2_profit, vcov = vcovCL(late2_profit, cluster = ~ areaid))

# Matrices para cluster
matriz_ITT1   <- vcovCL(itt1_consumo, cluster = ~ areaid)
matriz_ITT2   <- vcovCL(itt2_profit, cluster = ~ areaid)
matriz_LATE1   <- vcovCL(late1_consumo, cluster = ~ areaid)
matriz_LATE2  <- vcovCL(late2_profit, cluster = ~ areaid)

# Errores estandar
se_itt_consumo   <- sqrt(diag(matriz_ITT1))
se_itt_profit  <- sqrt(diag(matriz_ITT2))
se_late_consumo   <- sqrt(diag(matriz_LATE1))
se_late_profit   <- sqrt(diag(matriz_LATE2))

# Tabla
stargazer(itt1_consumo, itt2_profit,late1_consumo, late2_profit,
          type = "text",
          dep.var.labels.include = FALSE,
          dep.var.labels = NULL,
          se = list(se_itt_consumo,se_itt_profit,se_late_consumo,se_late_profit),
          column.labels = c("ITT consumo","ITT Utilidad", 
                            "LATE consumo", "LATE Utilidad"),
          title = "Impacto del microcrédito con errores agrupados por barrio")


```

El efecto de intención de tratar (ITT) mide el impacto promedio de vivir en un barrio donde se abrió una sucursal de microfinanzas, independientemente de que los hogares tomaran o no un crédito. En los resultados, los coeficientes de consumo y utilidades son positivos, pero no estadísticamente significativos, lo que sugiere que la mera presencia de la sucursal y la posibilidad de acceder a un préstamo no generaron cambios robustos en las condiciones económicas de los hogares.

Por su parte, el efecto local promedio del tratamiento (LATE) estima el impacto del microcrédito sobre los hogares cuya decisión de endeudarse dependió de la apertura de la sucursal (los *compliers*). Aunque los resultados muestran efectos de mayor magnitud en consumo y, especialmente, en utilidades, estos no alcanzan significancia estadística, lo que indica que incluso entre quienes tomaron crédito inducidos por la sucursal no hay evidencia concluyente de mejoras sostenidas en sus ingresos o consumo.

En conjunto, los resultados sugieren que, si bien el acceso al microcrédito incrementa el endeudamiento, su impacto causal sobre el consumo y las utilidades de los hogares no es estadísticamente significativo, lo que pone en cuestión la idea de que el microcrédito, por sí solo, sea un motor determinante de mejoras económicas a corto plazo.

**¿Cuál debería ser la relación matemática entre la tasa de cumplimiento, el *LATE* y el *ITT?* ¿Parece mantenerse esta relación en sus resultados? En una tabla presente sus cálculos de *LATE* matemáticos manuales y discuta.**

```{r}
# LATE manual 
late_consumo_manual <- itt_consumo_hat / p
late_profit_manual  <- itt_profit_hat  / p

# Tabla final
tabla_resultados <- data.frame(
  Outcome = c("Consumo", "Utilidad"),
  ITT = c(itt_consumo_hat, itt_profit_hat),
  Tasa_cumplimiento = c(p, p),
  LATE_manual = c(late_consumo_manual, late_profit_manual),
  LATE_IV = c(late_consumo_iv, late_profit_iv)
)
tabla_resultados

```

El LATE se obtiene dividiendo el estimador ITT por la tasa de cumplimiento. Esta identidad refleja que el ITT mide el efecto promedio de la asignación al tratamiento en toda la población, mientras que el LATE aísla el impacto del microcrédito únicamente en el subgrupo de hogares cuya decisión de endeudarse depende de dicha asignación (los *compliers*).

Al comparar los valores, se observa que los LATE calculados manualmente son muy similares a los estimados mediante el método de variables instrumentales, lo que confirma la coherencia de la estrategia. Las pequeñas diferencias entre ambos procedimientos se explican porque el cálculo manual no incorpora la estimación de errores estándar, covarianzas ni otros elementos estadísticos que sí considera la técnica de IV.

En conclusión, la relación matemática entre ITT, tasa de cumplimiento y LATE se cumple en la práctica, lo que respalda la validez de la estrategia de identificación utilizada y permite interpretar los resultados como una estimación confiable del efecto local del microcrédito sobre los hogares cuya participación fue inducida por la apertura de las sucursales.
