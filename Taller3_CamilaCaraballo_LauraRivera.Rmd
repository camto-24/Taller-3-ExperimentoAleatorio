---
title: "Taller 3 - Experimento Aleatorio"
author: "Maria Camila Caraballo, Laura Sarif Rivera"
date: "2025-09-10"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Experimentos Aleatorios

Esta es la introduccion

```{r cars}
summary(cars)
```

### 1. Análisis introductorio

Al introducir el artículo, los autores analizaron las limitaciones y lineamientos de la investigación de microcrédito publicada. ¿Cuáles son los problemas en la identificación del impacto del microcrédito si uno simplemente compara los que tienen microcrédito y los que no tienen microcrédito? ¿Qué método utilizan los autores para identificar tal impacto? ¿Cómo resuelve ese método los problemas antes mencionados?

### 2. Estimaciones originales

Los autores reportan los resultados de estimar la siguiente ecuación:

$$
y_{ia} = \alpha + \beta Treat_{ia} + X'_a\gamma + \epsilon_i
$$

Donde $y_{ia}$ es un resultado para el hogar $i$ en el área $a$, $Treat_{ia}$ es una dicótoma que toma el valor de 1 si el hogar está ubicado en un área tratada, mientras que $\beta$ es el efecto de $ITT$. $X_a$ es el vector con dimensión $K \cdot 1$ de variables de control.

a)  ¿Cuál es la unidad de análisis en el estudio?

Rta: La unidad de análisis son los hogares y el paper aleatoriza los barrios.

b)  Replique la tabla 2 panel A, columnas 1 y 3 para mostrar el efecto de microfinanzas (ser tratado por el programa) en la obtención de más préstamos (acceso a créditos). Explique la intuición detrás de los resultados. Presente sus resultados con 4 cifras significativas.

```{r}
# Cargar liberias y paquetes

#install.packages("haven") cual
#install.packages("plm")
#install.packages("skimr")
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("modelsummary")
#install.packages("knitr")
#install.packages("tinytex")
#tinytex::install_tinytex()
#install.packages("survey")
library(knitr)
library(haven)
library(plm)
library(scales)
library(skimr)
library(dplyr)
library(ggplot2)
library(AER)        
library(fixest)
library(lmtest)
library(sandwich)
library(tidyverse)
library(stargazer)
library(dplyr) 
library(survey)

# Leer archivo .dta
data <- read_dta("data_endline_1and2.dta")

# Ver base
str(data)

# Revisar NA de la base
colSums(is.na(data))

# Eliminar NA
data1 <- data %>% filter(!is.na(spandana_1))

# Filtrar solo hogares de Endline 1
data1 <- subset(data, sample1 == 1)

# Definir diseño muestral con pesos y clustering por área
design1 <- svydesign(
  id = ~areaid,   # cluster nivel área
  weights = ~w1,  # pesos 
  data = data1
)

# 5. Regresiones
c1 <- svyglm(
  spandana_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
  design = design1,
  family = gaussian()
)

c2 <- svyglm(
  anymfi_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
  design = design1,
  family = gaussian()
)

# 6. Mostrar tabla de resultados
stargazer(c1, c2, type = "text",
          keep = "treatment",
          covariate.labels = c("Treatment"),
          dep.var.labels = c("Spandana",
                             "Any MFI"),
          digits = 4,
          title = "Replicar Tabla 2- Credit")

```

c)  Replique la tabla 3 panel A, columnas  3 y 4. Explique la intuición detrás de los resultados. Recuerde incluir la corrección por sobremuestreo y errores cluster a nivel de área.

```{r}
# Revisar NA de la base
colSums(is.na(data1))

# Eliminar NA
data2 <- data %>% filter(!is.na(bizexpense_1))
data3 <- data %>% filter(!is.na(bizprofit_1))

# Definir diseño muestral con pesos y clustering por área en cada base
design2 <- svydesign(
  id = ~ areaid,   # cluster nivel área
  weights = ~ w1,  # pesos 
  data = data2
)
design3 <- svydesign(
  id = ~ areaid,   # cluster nivel área
  weights = ~ w1,  # pesos 
  data = data3
)

# Columna 3: Business assets
c3 <- svyglm(
  bizexpense_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
  design = design2,
  data = data2
)

# Columna 4: Business investment
c4 <- svyglm(
  bizprofit_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
  design = design3,
  data = data3
)

# Tabla 
stargazer(c3, c4, type = "text",
          keep = "treatment",
          covariate.labels = c("Treatment"),
          dep.var.labels = c("Expenses",
                             "Profit"),
          digits = 4,
          title = "TABLE 3 -(Panel A)")

```

d)  Usando “any MFI” como definición del tratamiento y “Treated Area” como asignación aleatoria inicial, calcule la tasa de cumplimiento (*compliance rate*) ¿Parece ser alta o baja? (Nota: incluya el ajuste para sobremuestreo)

```{r}
treated <- data$treatment== 1  # selecciona solo las áreas tratadas

# compliance rate ajustada por pesos
compliance_rate <- sum(data$anymfi_1[treated] * data$w1[treated]) /
                   sum(data$w1[treated])

compliance_rate

```

### 3. Cálculo de impacto

Ahora quieres estimar el impacto de recibir efectivamente un microcrédito sobre 2 variables: i) el consumo total (total_exp_mo_pc_1) y ii) los beneficios del negocio (*bizprofit_2*)

Para ello, se toma como variable de tratamiento efectivo a la dicótoma *anymfi_1* que toma el valor de uno si el hogar recibió algún préstamo de cualquier IMF para la línea final 1 y cero en caso contrario. Podemos tomar como instrumento el hecho de que la ubicación de los bancos fue aleatoria. Para esto, use como instrumento en sus estimaciones la asignación aleatoria.

Finalmente, no incluya ningún control en sus estimaciones y responda las siguientes preguntas teniendo en cuenta estas nociones y variables:

a)  **¿Cuáles son los supuestos necesarios para que los estimadores de VI sean válidos (en el contexto del artículo)?**

Rta: En el paper de Banerjee, Duflo, Glennerster y Kinnan (2015), la estrategia empírica consiste en estimar el efecto causal de recibir un préstamo de microcrédito de otras instituciones financieras (anymfi_1) sobre variables como el consumo (total_exp_mo_pc_1) y las utilidades del negocio (bizprofit_2). Dado que el acceso al crédito no fue asignado aleatoriamente si no que se trato de un spillover, los autores utilizan como instrumento la ubicación de los bancos de las instituciones dado de que fueron aletorias (treated_area). Para que el instrumento sea válido, se deberá contar con lo siguiente:

1)  Relevancia: la ubicación aleatoria de las sucursales de los bancos debe estar correlacionada con la probabilidad de que un hogar reciba microcrédito. En otras palabras, vivir en un área tratada debe aumentar significativamente la probabilidad de tener un préstamo.

2)  Exogeneidad: la variable instrumental (treated_area) debe ser independiente de los factores no observados que afectan directamente el resultado de interés (mejoras el bienestar como hogar). En este contexto, se justifica porque la asignación de las sucursales fue resultado de un procedimiento aleatorio, lo que garantiza que, en promedio, las áreas tratadas y de control eran comparables antes de la intervención.

    **b. Para cada una de las dos variables, estime el efecto *Local Average Treament Effect* de obtener un préstamo, a través del método de Variable Instrumental. Estime también el ITT. Para cada tipo de efecto (LATE e ITT) presente una tabla con sus estimaciones y sus respectivos errores estándar. Interprete sus resultados, ¿Cuál es la diferencia en la interpretación de los dos tipos de efecto?**

    Rta:

    Finalmente, bajo estos supuestos, la estimación por IV identifica un efecto local promedio del tratamiento (LATE), es decir, el impacto del microcrédito sobre los hogares cuya decisión de tomar un préstamo depende de la presencia de una sucursal en su área (compliers). Por tanto, los resultados no necesariamente reflejan el efecto para todos los hogares, sino para este subgrupo específico.

    SUTVA (Stable Unit Treatment Value Assumption): los resultados de un hogar deben depender únicamente de su propio estatus de tratamiento, y no del tratamiento asignado a otros hogares o áreas. En la práctica, este supuesto puede verse comprometido si existen efectos de derrame o spillovers entre hogares dentro o entre áreas, ya que la presencia de nuevas sucursales podría afectar a quienes no accedieron directamente al crédito.

<!-- -->

b)  **¿Cuál debería ser la relación matemática entre la tasa de cumplimiento, el *LATE* y el *ITT?* ¿Parece mantenerse esta relación en sus resultados? En una tabla presente sus cálculos de *LATE* matemáticos manuales y discuta.**
