)
# 8. Tabla estilo paper
stargazer(m3, m4, type = "text",
keep = "treatment",
covariate.labels = c("Treatment"),
dep.var.labels = c("Business assets (Endline 1)",
"Business investment (Endline 1)"),
digits = 4,
title = "Replication of Table 3, Panel A (Cols 3 & 4)")
library(survey)
library(stargazer)
# Filtrar muestra Endline 1
data1 <- subset(data, sample1 == 1)
# Reemplazar NA en variables dependientes con 0
data1$bizassets_1     <- ifelse(is.na(data1$bizassets_1), 0, data1$bizassets_1)
data1$bizinvestment_1 <- ifelse(is.na(data1$bizinvestment_1), 0, data1$bizinvestment_1)
# Reemplazar NA en covariable de control (para no perder observaciones)
data1$area_debt_total_base <- ifelse(is.na(data1$area_debt_total_base), 0, data1$area_debt_total_base)
# Columna 3: Business assets
m3 <- svyglm(
bizassets_1 ~ treatment + area_debt_total_base,
design = design1
)
# Columna 4: Business investment
m4 <- svyglm(
bizinvestment_1 ~ treatment + area_debt_total_base,
design = design1
)
# Tabla final
stargazer(m3, m4, type = "text",
keep = "treatment",
covariate.labels = c("Treatment"),
dep.var.labels = c("Business assets (Endline 1)",
"Business investment (Endline 1)"),
digits = 4,
title = "TABLE 3 - BUSINESS (Panel A)")
# Ver base
str(data)
treated <- data$treatment== 1  # selecciona solo las áreas tratadas
# compliance rate ajustada por pesos
compliance_rate <- sum(data$anymfi_1[treatment] * data$weight[treatment]) /
sum(data$weight[treatment])
treated <- data$treatment== 1  # selecciona solo las áreas tratadas
# compliance rate ajustada por pesos
compliance_rate <- sum(data$anymfi_1[treated] * data$w1[treated]) /
sum(data$w1[treated])
compliance_rate
# Cargar liberias y paquetes
#install.packages("haven") cual
#install.packages("plm")
#install.packages("skimr")
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("modelsummary")
#install.packages("knitr")
#install.packages("tinytex")
#tinytex::install_tinytex()
#install.packages("survey")
library(knitr)
library(haven)
library(plm)
library(scales)
library(skimr)
library(dplyr)
library(ggplot2)
library(AER)
library(fixest)
library(lmtest)
library(sandwich)
library(tidyverse)
library(stargazer)
library(dplyr)
library(survey)
# Leer archivo .dta
data <- read_dta("data_endline_1and2.dta")
# Ver base
str(data)
# Revisar NA de la base
colSums(is.na(data))
# Eliminar NA
data1 <- data %>% filter(!is.na(spandana_1))
# Filtrar solo hogares de Endline 1
data1 <- subset(data, sample1 == 1)
# Definir diseño muestral con pesos y clustering por área
design1 <- svydesign(
id = ~areaid,   # cluster nivel área
weights = ~w1,  # pesos
data = data1
)
# 5. Regresiones
c1 <- svyglm(
spandana_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
design = design1,
family = gaussian()
)
c2 <- svyglm(
anymfi_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
design = design1,
family = gaussian()
)
# 6. Mostrar tabla de resultados
stargazer(c1, c2, type = "text",
keep = "treatment",
covariate.labels = c("Treatment"),
dep.var.labels = c("Spandana",
"Any MFI"),
digits = 4,
title = "Replicar Tabla 2- Credit")
# Revisar NA de la base
colSums(is.na(data1))
# Eliminar NA
data2 <- data %>% filter(!is.na(bizexpense_1))
data3 <- data %>% filter(!is.na(bizprofit_1))
# Definir diseño muestral con pesos y clustering por área en cada base
design2 <- svydesign(
id = ~ areaid,   # cluster nivel área
weights = ~ w1,  # pesos
data = data2
)
design3 <- svydesign(
id = ~ areaid,   # cluster nivel área
weights = ~ w1,  # pesos
data = data3
)
# Columna 3: Business assets
c3 <- svyglm(
bizexpense_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
design = design2,
data = data2
)
# Columna 4: Business investment
c4 <- svyglm(
bizprofit_1 ~ treatment + area_debt_total_base + area_pop_base + area_business_total_base + area_exp_pc_mean_base + area_literate_head_base + area_literate_base,
design = design3,
data = data3
)
# Tabla
stargazer(c3, c4, type = "text",
keep = "treatment",
covariate.labels = c("Treatment"),
dep.var.labels = c("Expenses",
"Profit"),
digits = 4,
title = "TABLE 3 -(Panel A)")
View(data)
data4 <- data %>% filter(!is.na(total_exp_mo_pc_1))
data5 <- data %>% filter(!is.na(bizprofit_2))
# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1 <- lm(total_exp_mo_pc_1 ~ anymfi_1, data = data4, weights = w)
itt2 <- lm(bizprofit_2 ~ anymfi_1, data = data5, weights = w)
# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1 <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w, data = data4)
late2 <- ivreg(bizprofit_2 ~ anymfi_1 | treatment, weights = w, data = data5)
# Eliminar NA
data4 <- data %>% filter(!is.na(total_exp_mo_pc_1))
data5 <- data %>% filter(!is.na(bizprofit_2))
# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1_consumo <- lm(total_exp_mo_pc_1 ~ anymfi_1, data = data4, weights = w)
itt2_profit <- lm(bizprofit_2 ~ anymfi_1, data = data5, weights = w)
# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1_consumo <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w, data = data4)
late2_profit <- ivreg(bizprofit_2 ~ anymfi_1 | treatment, weights = w, data = data5)
# Agrupar errores por barrio ITT
coeftest(itt1_consumo, vcov = vcovCL(itt1_consumo, cluster = ~ area_id))
# Eliminar NA
data4 <- data %>% filter(!is.na(total_exp_mo_pc_1))
data5 <- data %>% filter(!is.na(bizprofit_2))
# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1_consumo <- lm(total_exp_mo_pc_1 ~ anymfi_1, data = data4, weights = w)
itt2_profit <- lm(bizprofit_2 ~ anymfi_1, data = data5, weights = w)
# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1_consumo <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w, data = data4)
late2_profit <- ivreg(bizprofit_2 ~ anymfi_1 | treatment, weights = w, data = data5)
# Agrupar errores por barrio ITT
coeftest(itt1_consumo, vcov = vcovCL(itt1_consumo, cluster = ~ areaid))
coeftest(itt2_profit, vcov = vcovCL(itt2_profit, cluster = ~ areaid))
# Agrupar errores por barrio LATE
coeftest(late1_consumo, vcov = vcovCL(late1_consumo, cluster = ~ areaid))
coeftest(late2_profit, vcov = vcovCL(late2_profit, cluster = ~ areaid))
# Matrices para cluster
matriz_ITT1   <- vcovCL(itt1_consumo, cluster = ~ areaid)
matriz_ITT2   <- vcovCL(itt2_profit, cluster = ~ areaid)
matriz_LATE1   <- vcovCL(late1_consumo, cluster = ~ areaid)
matriz_LATE2  <- vcovCL(late2_profit, cluster = ~ areaid)
# Errores estandar
se_itt_consumo   <- sqrt(diag(matriz_ITT1))
se_itt_profit  <- sqrt(diag(matriz_ITT2))
se_late_consumo   <- sqrt(diag(matriz_LATE1))
se_late_profit   <- sqrt(diag(matriz_LATE2))
# Tabla
stargazer(itt1_consumo, itt2_profit,late1_consumo, late2_profit,
type = "latex",
se = list(se_itt_consumo,se_itt_profit,se_late_consumo,se_late_profit),
column.labels = c("ITT consumo","ITT profit",
"LATE consumo", "LATE profit"),
title = "Impacto del microcrédito con errores agrupados por barrio")
# Eliminar NA
data4 <- data %>% filter(!is.na(total_exp_mo_pc_1))
data5 <- data %>% filter(!is.na(bizprofit_2))
# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1_consumo <- lm(total_exp_mo_pc_1 ~ anymfi_1, data = data4, weights = w)
itt2_profit <- lm(bizprofit_2 ~ anymfi_1, data = data5, weights = w)
# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1_consumo <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w, data = data4)
late2_profit <- ivreg(bizprofit_2 ~ anymfi_1 | treatment, weights = w, data = data5)
# Agrupar errores por barrio ITT
coeftest(itt1_consumo, vcov = vcovCL(itt1_consumo, cluster = ~ areaid))
coeftest(itt2_profit, vcov = vcovCL(itt2_profit, cluster = ~ areaid))
# Agrupar errores por barrio LATE
coeftest(late1_consumo, vcov = vcovCL(late1_consumo, cluster = ~ areaid))
coeftest(late2_profit, vcov = vcovCL(late2_profit, cluster = ~ areaid))
# Matrices para cluster
matriz_ITT1   <- vcovCL(itt1_consumo, cluster = ~ areaid)
matriz_ITT2   <- vcovCL(itt2_profit, cluster = ~ areaid)
matriz_LATE1   <- vcovCL(late1_consumo, cluster = ~ areaid)
matriz_LATE2  <- vcovCL(late2_profit, cluster = ~ areaid)
# Errores estandar
se_itt_consumo   <- sqrt(diag(matriz_ITT1))
se_itt_profit  <- sqrt(diag(matriz_ITT2))
se_late_consumo   <- sqrt(diag(matriz_LATE1))
se_late_profit   <- sqrt(diag(matriz_LATE2))
# Tabla
stargazer(itt1_consumo, itt2_profit,late1_consumo, late2_profit,
type = "text",
se = list(se_itt_consumo,se_itt_profit,se_late_consumo,se_late_profit),
column.labels = c("ITT consumo","ITT profit",
"LATE consumo", "LATE profit"),
title = "Impacto del microcrédito con errores agrupados por barrio")
# Eliminar NA
data4 <- data %>% filter(!is.na(total_exp_mo_pc_1))
data5 <- data %>% filter(!is.na(bizprofit_1))
# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1_consumo <- lm(total_exp_mo_pc_1 ~ anymfi_1, data = data4, weights = w1)
itt2_profit <- lm(bizprofit_1 ~ anymfi_1, data = data5, weights = w1)
# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1_consumo <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w1, data = data4)
late2_profit <- ivreg(bizprofit_1 ~ anymfi_1 | treatment, weights = w1, data = data5)
# Agrupar errores por barrio ITT
coeftest(itt1_consumo, vcov = vcovCL(itt1_consumo, cluster = ~ areaid))
coeftest(itt2_profit, vcov = vcovCL(itt2_profit, cluster = ~ areaid))
# Agrupar errores por barrio LATE
coeftest(late1_consumo, vcov = vcovCL(late1_consumo, cluster = ~ areaid))
coeftest(late2_profit, vcov = vcovCL(late2_profit, cluster = ~ areaid))
# Matrices para cluster
matriz_ITT1   <- vcovCL(itt1_consumo, cluster = ~ areaid)
matriz_ITT2   <- vcovCL(itt2_profit, cluster = ~ areaid)
matriz_LATE1   <- vcovCL(late1_consumo, cluster = ~ areaid)
matriz_LATE2  <- vcovCL(late2_profit, cluster = ~ areaid)
# Errores estandar
se_itt_consumo   <- sqrt(diag(matriz_ITT1))
se_itt_profit  <- sqrt(diag(matriz_ITT2))
se_late_consumo   <- sqrt(diag(matriz_LATE1))
se_late_profit   <- sqrt(diag(matriz_LATE2))
# Tabla
stargazer(itt1_consumo, itt2_profit,late1_consumo, late2_profit,
type = "text",
se = list(se_itt_consumo,se_itt_profit,se_late_consumo,se_late_profit),
column.labels = c("ITT consumo","ITT profit",
"LATE consumo", "LATE profit"),
title = "Impacto del microcrédito con errores agrupados por barrio")
treated <- data$treatment== 1  # selecciona solo las áreas tratadas
# compliance rate ajustada por pesos
tasa_cumplimiento <- sum(data$anymfi_1[treated] * data$w1[treated]) /
sum(data$w1[treated])
tasa_cumplimiento
# Revisar NA de la base
colSums(is.na(data1))
# Eliminar NA
data_tasa_cum <- data %>% filter(!is.na(anymfi_1))
# Eliminar NA
data_tasa_cum <- data %>% filter(!is.na(anymfi_1))
treated <- data_tasa_cum$treatment== 1  # selecciona solo las áreas tratadas
# compliance rate ajustada por pesos
tasa_cumplimiento <- sum(data_tasa_cum$anymfi_1[treated] * data_tasa_cum$w1[treated]) /
sum(data_tasa_cum$w1[treated])
tasa_cumplimiento
comp_rate_weighted <- data_tasa_cum %>%
group_by(treatment) %>%
summarise(mean_anymfi_w = weighted.mean(anymfi_1, w = weight, na.rm = TRUE)) %>%
summarise(compliance_rate = diff(mean_anymfi_w))
comp_rate_weighted <- data_tasa_cum %>%
group_by(treatment) %>%
summarise(mean_anymfi_w = weighted.mean(anymfi_1, w = w1, na.rm = TRUE)) %>%
summarise(compliance_rate = diff(mean_anymfi_w))
comp_rate_weighted
# Revisar NA de la base
colSums(is.na(data1))
# Eliminar NA
data_tasa_cum <- data %>% filter(!is.na(anymfi_1))
# tasa de cumplimiento en tratados
tasa_cumplimiento <- data_tasa_cum %>%
filter(treatment == 1) %>%
summarise(tasa_cumplimiento = weighted.mean(anymfi_1, w = w1, na.rm = TRUE))
tasa_cumplimiento
# Eliminar NA
data_tasa_cum <- data %>% filter(!is.na(anymfi_1))
# Numerador = tratados que recibieron préstamo
num <- sum(data_tasa_cum$anymfi_1[data_tasa_cum$treatment == 1] *
data_tasa_cum$w1[data_tasa_cum$treatment == 1], na.rm = TRUE)
# Denominador = todos (tratados y controles)
den <- sum(data_tasa_cum$w1, na.rm = TRUE)
# Tasa: tratados cumplidores sobre el total de la muestra
tasa_cumplimiento_total <- num / den
tasa_cumplimiento_total
# Eliminar NA
data_clean <- data %>% filter(!is.na(anymfi_1), !is.na(treatment), !is.na(w1))
# tasas de cumplimiento por grupo
comp_rates <- data_clean %>%
group_by(treatment) %>%
summarise(compliance_rate = weighted.mean(anymfi_1, w = w1, na.rm = TRUE))
comp_rates
# calcular la diferencia (first stage)
first_stage <- comp_rates$compliance_rate[comp_rates$treatment == 1] -
comp_rates$compliance_rate[comp_rates$treatment == 0]
first_stage
# Eliminar NA
data4 <- data %>% filter(!is.na(total_exp_mo_pc_1))
data5 <- data %>% filter(!is.na(bizprofit_1))
# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1_consumo <- lm(total_exp_mo_pc_1 ~ anymfi_1, data = data4, weights = w1)
itt2_profit <- lm(bizprofit_1 ~ anymfi_1, data = data5, weights = w1)
# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1_consumo <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w1, data = data4)
late2_profit <- ivreg(bizprofit_1 ~ anymfi_1 | treatment, weights = w1, data = data5)
# Agrupar errores por barrio ITT
coeftest(itt1_consumo, vcov = vcovCL(itt1_consumo, cluster = ~ areaid))
coeftest(itt2_profit, vcov = vcovCL(itt2_profit, cluster = ~ areaid))
# Agrupar errores por barrio LATE
coeftest(late1_consumo, vcov = vcovCL(late1_consumo, cluster = ~ areaid))
coeftest(late2_profit, vcov = vcovCL(late2_profit, cluster = ~ areaid))
# Matrices para cluster
matriz_ITT1   <- vcovCL(itt1_consumo, cluster = ~ areaid)
matriz_ITT2   <- vcovCL(itt2_profit, cluster = ~ areaid)
matriz_LATE1   <- vcovCL(late1_consumo, cluster = ~ areaid)
matriz_LATE2  <- vcovCL(late2_profit, cluster = ~ areaid)
# Errores estandar
se_itt_consumo   <- sqrt(diag(matriz_ITT1))
se_itt_profit  <- sqrt(diag(matriz_ITT2))
se_late_consumo   <- sqrt(diag(matriz_LATE1))
se_late_profit   <- sqrt(diag(matriz_LATE2))
# Tabla
stargazer(itt1_consumo, itt2_profit,late1_consumo, late2_profit,
type = "text",
se = list(se_itt_consumo,se_itt_profit,se_late_consumo,se_late_profit),
column.labels = c("ITT consumo","ITT profit",
"LATE consumo", "LATE profit"),
title = "Impacto del microcrédito con errores agrupados por barrio")
# Eliminar NA
data_clean <- data %>% filter(!is.na(anymfi_1), !is.na(treatment), !is.na(w1))
# tasas de cumplimiento por grupo
comp_rates <- data_clean %>%
group_by(treatment) %>%
summarise(tasa_cumplimiento = weighted.mean(anymfi_1, w = w1, na.rm = TRUE))
comp_rates
# calcular la diferencia (first stage)
first_stage <- comp_rates$tasa_cumplimiento[comp_rates$treatment == 1] -
comp_rates$tasa_cumplimiento[comp_rates$treatment == 0]
first_stage
p <- first_stage # guardar
# LATE manual
late_consumo_manual <- itt_consumo_hat / p
# Eliminar NA
data4 <- data %>% filter(!is.na(total_exp_mo_pc_1))
data5 <- data %>% filter(!is.na(bizprofit_1))
# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1_consumo <- lm(total_exp_mo_pc_1 ~ anymfi_1, data = data4, weights = w1)
itt2_profit <- lm(bizprofit_1 ~ anymfi_1, data = data5, weights = w1)
# Guardar coeficientes ITT
itt_consumo_hat <- coef(itt1_consumo)["treatment"]
itt_profit_hat  <- coef(itt2_profit)["treatment"]
# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1_consumo <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w1, data = data4)
late2_profit <- ivreg(bizprofit_1 ~ anymfi_1 | treatment, weights = w1, data = data5)
# Guardar coeficientes LATE
late_consumo_iv <- coef(late1_consumo)["anymfi_1"]
late_profit_iv  <- coef(late2_profit)["anymfi_1"]
# Agrupar errores por barrio ITT
coeftest(itt1_consumo, vcov = vcovCL(itt1_consumo, cluster = ~ areaid))
coeftest(itt2_profit, vcov = vcovCL(itt2_profit, cluster = ~ areaid))
# Agrupar errores por barrio LATE
coeftest(late1_consumo, vcov = vcovCL(late1_consumo, cluster = ~ areaid))
coeftest(late2_profit, vcov = vcovCL(late2_profit, cluster = ~ areaid))
# Matrices para cluster
matriz_ITT1   <- vcovCL(itt1_consumo, cluster = ~ areaid)
matriz_ITT2   <- vcovCL(itt2_profit, cluster = ~ areaid)
matriz_LATE1   <- vcovCL(late1_consumo, cluster = ~ areaid)
matriz_LATE2  <- vcovCL(late2_profit, cluster = ~ areaid)
# Errores estandar
se_itt_consumo   <- sqrt(diag(matriz_ITT1))
se_itt_profit  <- sqrt(diag(matriz_ITT2))
se_late_consumo   <- sqrt(diag(matriz_LATE1))
se_late_profit   <- sqrt(diag(matriz_LATE2))
# Tabla
stargazer(itt1_consumo, itt2_profit,late1_consumo, late2_profit,
type = "text",
se = list(se_itt_consumo,se_itt_profit,se_late_consumo,se_late_profit),
column.labels = c("ITT consumo","ITT profit",
"LATE consumo", "LATE profit"),
title = "Impacto del microcrédito con errores agrupados por barrio")
# LATE manual
late_consumo_manual <- itt_consumo_hat / p
late_profit_manual  <- itt_profit_hat  / p
# Tabla
tabla_resultados <- data.frame(
Outcome = c("Consumo", "Profit"),
ITT = c(itt_consumo_hat, itt_profit_hat),
Tasa_cumplimiento = c(p, p),
LATE_manual = c(late_consumo_manual, late_profit_manual),
LATE_IV = c(late_consumo_iv, late_profit_iv)
)
tabla_resultados
# LATE manual (correcto con ITT arreglado)
late_consumo_manual <- itt_consumo_hat / p
late_profit_manual  <- itt_profit_hat  / p
# Tabla final
tabla_resultados <- data.frame(
Outcome = c("Consumo", "Profit"),
ITT = c(itt_consumo_hat, itt_profit_hat),
Tasa_cumplimiento = c(p, p),
LATE_manual = c(late_consumo_manual, late_profit_manual),
LATE_IV = c(late_consumo_iv, late_profit_iv)
)
tabla_resultados
# Eliminar NA
data4 <- data %>% filter(!is.na(total_exp_mo_pc_1))
data5 <- data %>% filter(!is.na(bizprofit_1))
# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1_consumo <- lm(total_exp_mo_pc_1 ~ treatment, data = data4, weights = w1)
itt2_profit  <- lm(bizprofit_1 ~ treatment, data = data5, weights = w1)
# Guardar coeficientes ITT
itt_consumo_hat <- coef(itt1_consumo)["treatment"]
itt_profit_hat  <- coef(itt2_profit)["treatment"]
# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1_consumo <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w1, data = data4)
late2_profit <- ivreg(bizprofit_1 ~ anymfi_1 | treatment, weights = w1, data = data5)
# Guardar coeficientes LATE
late_consumo_iv <- coef(late1_consumo)["anymfi_1"]
late_profit_iv  <- coef(late2_profit)["anymfi_1"]
# Agrupar errores por barrio ITT
coeftest(itt1_consumo, vcov = vcovCL(itt1_consumo, cluster = ~ areaid))
coeftest(itt2_profit, vcov = vcovCL(itt2_profit, cluster = ~ areaid))
# Agrupar errores por barrio LATE
coeftest(late1_consumo, vcov = vcovCL(late1_consumo, cluster = ~ areaid))
coeftest(late2_profit, vcov = vcovCL(late2_profit, cluster = ~ areaid))
# Matrices para cluster
matriz_ITT1   <- vcovCL(itt1_consumo, cluster = ~ areaid)
matriz_ITT2   <- vcovCL(itt2_profit, cluster = ~ areaid)
matriz_LATE1   <- vcovCL(late1_consumo, cluster = ~ areaid)
matriz_LATE2  <- vcovCL(late2_profit, cluster = ~ areaid)
# Errores estandar
se_itt_consumo   <- sqrt(diag(matriz_ITT1))
se_itt_profit  <- sqrt(diag(matriz_ITT2))
se_late_consumo   <- sqrt(diag(matriz_LATE1))
se_late_profit   <- sqrt(diag(matriz_LATE2))
# Tabla
stargazer(itt1_consumo, itt2_profit,late1_consumo, late2_profit,
type = "text",
se = list(se_itt_consumo,se_itt_profit,se_late_consumo,se_late_profit),
column.labels = c("ITT consumo","ITT profit",
"LATE consumo", "LATE profit"),
title = "Impacto del microcrédito con errores agrupados por barrio")
# Eliminar NA
data4 <- data %>% filter(!is.na(total_exp_mo_pc_1))
data5 <- data %>% filter(!is.na(bizprofit_1))
# Intention-to-Treat (ITT) esto compara todos los municipios tratados vs. control.
itt1_consumo <- lm(total_exp_mo_pc_1 ~ treatment, data = data4, weights = w1)
itt2_profit  <- lm(bizprofit_1 ~ treatment, data = data5, weights = w1)
# Guardar coeficientes ITT
itt_consumo_hat <- coef(itt1_consumo)["treatment"]
itt_profit_hat  <- coef(itt2_profit)["treatment"]
# LATE (Local Average Treatment Effect) es el efecto promedio para los individuos cuyo estatus de tratamiento está determinado por el instrumento
late1_consumo <- ivreg(total_exp_mo_pc_1 ~ anymfi_1 | treatment, weights = w1, data = data4)
late2_profit <- ivreg(bizprofit_1 ~ anymfi_1 | treatment, weights = w1, data = data5)
# Guardar coeficientes LATE
late_consumo_iv <- coef(late1_consumo)["anymfi_1"]
late_profit_iv  <- coef(late2_profit)["anymfi_1"]
# Agrupar errores por barrio ITT
coeftest(itt1_consumo, vcov = vcovCL(itt1_consumo, cluster = ~ areaid))
coeftest(itt2_profit, vcov = vcovCL(itt2_profit, cluster = ~ areaid))
# Agrupar errores por barrio LATE
coeftest(late1_consumo, vcov = vcovCL(late1_consumo, cluster = ~ areaid))
coeftest(late2_profit, vcov = vcovCL(late2_profit, cluster = ~ areaid))
# Matrices para cluster
matriz_ITT1   <- vcovCL(itt1_consumo, cluster = ~ areaid)
matriz_ITT2   <- vcovCL(itt2_profit, cluster = ~ areaid)
matriz_LATE1   <- vcovCL(late1_consumo, cluster = ~ areaid)
matriz_LATE2  <- vcovCL(late2_profit, cluster = ~ areaid)
# Errores estandar
se_itt_consumo   <- sqrt(diag(matriz_ITT1))
se_itt_profit  <- sqrt(diag(matriz_ITT2))
se_late_consumo   <- sqrt(diag(matriz_LATE1))
se_late_profit   <- sqrt(diag(matriz_LATE2))
# Tabla
stargazer(itt1_consumo, itt2_profit,late1_consumo, late2_profit,
type = "text",
se = list(se_itt_consumo,se_itt_profit,se_late_consumo,se_late_profit),
column.labels = c("ITT consumo","ITT profit",
"LATE consumo", "LATE profit"),
title = "Impacto del microcrédito con errores agrupados por barrio")
# LATE manual (correcto con ITT arreglado)
late_consumo_manual <- itt_consumo_hat / p
late_profit_manual  <- itt_profit_hat  / p
# Tabla final
tabla_resultados <- data.frame(
Outcome = c("Consumo", "Profit"),
ITT = c(itt_consumo_hat, itt_profit_hat),
Tasa_cumplimiento = c(p, p),
LATE_manual = c(late_consumo_manual, late_profit_manual),
LATE_IV = c(late_consumo_iv, late_profit_iv)
)
tabla_resultados
late1_consumo
